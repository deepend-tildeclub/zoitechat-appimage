name: Debian Packages

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  debian_packages:
    runs-on: ubuntu-24.04
    container:
      image: debian:bookworm

    steps:
      - name: Install git (required for checkout + submodules)
        run: |
          set -eux
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates git openssh-client

      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Install Debian packaging tooling
        run: |
          set -eux
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y --no-install-recommends \
            devscripts equivs fakeroot dpkg-dev

      - name: Enable deb-src + install HexChat build-deps
        run: |
          set -eux
          export DEBIAN_FRONTEND=noninteractive

          # Enable source repositories (needed for `apt-get build-dep`)
          cat >/etc/apt/sources.list.d/deb-src.list <<'EOF'
          deb-src http://deb.debian.org/debian bookworm main
          deb-src http://deb.debian.org/debian bookworm-updates main
          deb-src http://deb.debian.org/debian-security bookworm-security main
          EOF

          apt-get update

          # Pull HexChat's build dependencies from Debian packaging
          apt-get build-dep -y --no-install-recommends hexchat

      - name: Install Build-Depends from this repo's debian/control
        run: |
          set -eux
          mk-build-deps -i -r -t "apt-get -y --no-install-recommends" debian/control

      - name: Build .deb packages (no signing)
        run: |
          set -eux
          useradd -m builder
          chown -R builder:builder "$GITHUB_WORKSPACE"
          su - builder -s /bin/bash -c "cd '$GITHUB_WORKSPACE' && dpkg-buildpackage -us -uc -b"

      - name: List built artifacts
        run: |
          set -eux
          ls -lah ..

      - uses: actions/upload-artifact@v4
        with:
          name: debian-packages
          path: |
            ../*.deb
            ../*.buildinfo
            ../*.changes
